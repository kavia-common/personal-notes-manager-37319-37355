---
/**
 * PUBLIC_INTERFACE
 * ConfirmDialog.astro
 * Lightweight confirm dialog. Show by dispatching:
 *   window.dispatchEvent(new CustomEvent('confirm-dialog', {
 *     detail: { title, message, confirmLabel?: 'Confirm', cancelLabel?: 'Cancel', onConfirm: () => {} }
 *   }))
 */
---
<dialog id="confirm-dialog" role="dialog" aria-modal="true" aria-labelledby="cd-title" aria-describedby="cd-message">
  <form method="dialog" class="card" style="padding:16px; min-width: 280px;">
    <h3 id="cd-title" style="margin-top:0;">Confirm</h3>
    <p id="cd-message" class="text-muted" style="margin: 6px 0 16px;"></p>
    <div style="display:flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;">
      <button id="cd-cancel" value="cancel" class="btn" style="border-color: var(--color-border);">Cancel</button>
      <button id="cd-ok" value="confirm" class="btn btn-primary" autofocus>Confirm</button>
    </div>
  </form>
</dialog>

<style>
  dialog::backdrop {
    background: color-mix(in oklab, #000, transparent 70%);
  }
  dialog[open] {
    animation: fadeIn .12s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  const dlg = document.getElementById('confirm-dialog');
  const elT = document.getElementById('cd-title');
  const elM = document.getElementById('cd-message');
  const elOk = document.getElementById('cd-ok');
  const elCancel = document.getElementById('cd-cancel');

  let lastActive = null;

  function show({ title = 'Confirm', message = '', confirmLabel = 'Confirm', cancelLabel = 'Cancel', onConfirm }) {
    elT.textContent = title;
    elM.textContent = message;
    elOk.textContent = confirmLabel;
    elCancel.textContent = cancelLabel;

    lastActive = document.activeElement;

    const onClose = (ev) => {
      dlg.removeEventListener('close', onClose);
      if (dlg.returnValue === 'confirm' && typeof onConfirm === 'function') {
        onConfirm();
      }
      // return focus to the last active element
      if (lastActive && typeof lastActive.focus === 'function') {
        lastActive.focus();
      }
    };
    dlg.addEventListener('close', onClose, { once: true });
    if (typeof dlg.showModal === 'function') {
      dlg.showModal();
    } else {
      dlg.setAttribute('open', 'true');
    }

    // rudimentary focus trap
    const onKey = (e) => {
      if (e.key === 'Tab') {
        const focusables = dlg.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault(); (last as HTMLElement).focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault(); (first as HTMLElement).focus();
        }
      } else if (e.key === 'Escape') {
        dlg.close('cancel');
      }
    };
    dlg.addEventListener('keydown', onKey, { once: true });
  }

  function onEvt(e) {
    show(e.detail || {});
  }

  window.addEventListener('confirm-dialog', onEvt);
</script>
